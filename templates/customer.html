<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Customer Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/customer.css') }}">
    <meta http-equiv="Cache-Control" content="no-store" />
    <script>
        // on page load ensure session still active; if not, redirect to home
        document.addEventListener('DOMContentLoaded', function(){
            fetch('/api/check_session', { credentials: 'same-origin' })
                .then(r => r.json())
                .then(d => {
                    if (!d.logged_in) window.location.href = '/';
                })
                .catch(()=>{ /* ignore network errors */ });
        });
    </script>
</head>
<body>
    <!-- Modal for Order Tracking -->
    <div id="trackDeliveryModal" class="modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);z-index:1000;align-items:center;justify-content:center;">
        <div style="background:#fff;padding:30px 40px;border-radius:10px;min-width:320px;max-width:90vw;">
            <h3>Order Tracking</h3>
            <div id="trackingSteps" style="margin:30px 0 10px 0;"></div>
            <button onclick="document.getElementById('trackDeliveryModal').style.display='none'" class="btn btn-secondary">Close</button>
        </div>
    </div>

    <!-- Modal for Payment Options -->
    <div id="paymentModal" class="modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);z-index:1000;align-items:center;justify-content:center;">
        <div style="background:#fff;padding:30px 40px;border-radius:10px;min-width:320px;max-width:90vw;">
            <h3>Select Payment Method</h3>
            <p>Order ID: <span id="paymentOrderId"></span></p>
            <p>Amount: â‚¹<span id="paymentAmount"></span></p>
            <button id="manualPaymentBtn" class="payment-btn" style="background:#28a745;color:white;padding:10px 20px;border:none;border-radius:5px;margin:10px;">Manual Payment (Cash on Delivery)</button>
            <button id="upiPaymentBtn" class="payment-btn" style="background:#0077cc;color:white;padding:10px 20px;border:none;border-radius:5px;margin:10px;">Pay via UPI</button>
            <button onclick="document.getElementById('paymentModal').style.display='none'" style="background:#6c757d;color:white;padding:10px 20px;border:none;border-radius:5px;margin:10px;">Cancel</button>
            <div id="upiDetails" style="display:none;margin-top:20px;">
                <h4>UPI Payment Details</h4>
                <p>Send payment to: <b>smartflow@upi</b></p>
                <form id="upiProofForm" enctype="multipart/form-data">
                    <label>Transaction ID:<br><input type="text" id="transactionIdInput" name="transaction_id" required style="width:100%;margin-bottom:10px;"></label><br>
                    <label>Upload Payment Proof:<br><input type="file" id="paymentProofInput" name="payment_proof" accept="image/*" required></label><br>
                    <button type="submit" style="background:#28a745;color:white;padding:8px 18px;border:none;border-radius:5px;margin-top:10px;">Submit Payment Proof</button>
                </form>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/track_delivery.js') }}"></script>

    <!-- Navbar -->
    <!-- Navbar -->
    <nav class="navbar">
        <div class="brand">ğŸšš <span>Dispatch System</span></div>
        <div class="profile-dropdown">
        <button id="profileBtn" class="profile-btn">ğŸ‘¤ Profile â–¾</button>
        <div id="dropdownContent" class="dropdown-content">
            <a href="/customer/profile/{{ user.customer_id }}">ğŸ‘¤ View Profile</a>
            <a href="#" id="themeToggle">ğŸŒ“ Toggle Theme</a>
            <a href="/logout">ğŸšª Logout</a>
            </div>
        </div>
    </nav>

        <script>
            // Profile dropdown toggle for customer page
            document.addEventListener('DOMContentLoaded', function(){
                const profileBtn = document.getElementById('profileBtn');
                const dropdown = document.getElementById('dropdownContent');
                if (profileBtn) {
                    profileBtn.addEventListener('click', function(e){
                        e.stopPropagation();
                        dropdown.classList.toggle('show');
                    });
                    document.body.addEventListener('click', function(){ dropdown.classList.remove('show'); });
                }
            });

                // session check helper to handle bfcache/back-button: redirect to home if session invalid
                function checkSessionAndRedirectCustomer() {
                    try {
                        fetch('/api/check_session', { credentials: 'same-origin' })
                            .then(r => r.json())
                            .then(d => { if (!d.logged_in) window.location.href = '/'; })
                            .catch(()=>{});
                    } catch (e) {}
                }

                // run on initial load and when page is shown from bfcache or via back navigation
                document.addEventListener('DOMContentLoaded', checkSessionAndRedirectCustomer);
                window.addEventListener('pageshow', function(e) { if (e.persisted) checkSessionAndRedirectCustomer(); });
                window.addEventListener('popstate', checkSessionAndRedirectCustomer);

        </script>


    <!-- Hero Section -->
    <section class="hero">
        <div class="hero-text">
            <h1>Welcome to Smart Dispatch System</h1>
            <p>Effortless order placement, transparent tracking, and fast deliveries for dealers and distributors.</p>
            <ul>
                <li>ğŸ“¦ Place and track your orders instantly</li>
                <li>ğŸšš View delivery status and payment info</li>
                <li>ğŸ“ˆ Get analytics and support</li>
            </ul>
        </div>
    </section>

    <!-- Dashboard Section -->
    <main class="dashboard">
        <header class="dashboard-header">
            <h2>Hello, <span class="customer-highlight">{{ customer_name }}</span> ğŸ‘‹</h2>
            <p style="color:#888;margin-top:4px;">Your personalized order dashboard</p>
        </header>
        <div class="cards">
    <a href="/place_order/{{ user.customer_id }}" class="card small-card" id="orderBtn">ğŸ“¦ Place New Order</a>
        <button id="viewOrdersBtn" class="card small-card">ğŸ“‹ View My Orders</button>
        <button id="quickProfileBtn" class="card small-card">ğŸ‘¤ Quick Profile</button>
        <button id="helpBtn" class="card small-card">â“ Help</button>
        <button id="refreshBtn" class="card small-card">ğŸ”„ Refresh</button>
        </div>


        <section id="ordersSection" class="orders-section" style="display:none;">
            <div class="section-header">
                <h2>ğŸ§¾ My Orders</h2>
                <button id="closeOrdersBtn" class="back-btn">Close</button>
            </div>
            <div id="ordersList" class="orders-list">Loading...</div>
        </section>

        <section id="profileQuickView" class="orders-section" style="display:none;">
            <div class="section-header">
                <h2>ğŸ‘¤ Profile Quick View</h2>
                <button id="closeProfileQuick" class="back-btn">Close</button>
            </div>
            <div id="profileQuickContent" style="padding:1.2em;"></div>
        </section>

        <section id="helpSection" class="orders-section" style="display:none;">
            <div class="section-header">
                <h2>â“ Help & Tips</h2>
                <button id="closeHelp" class="back-btn">Close</button>
            </div>
            <div style="padding:1.2em;">
                <ul style="font-size:1.08em;color:#1976d2;">
                    <li>Click <b>Place New Order</b> to start a new purchase.</li>
                    <li>Use <b>View My Orders</b> to track and pay for your orders.</li>
                    <li>Quick Profile gives you a summary of your info.</li>
                    <li>Toggle between light/dark mode for comfort.</li>
                    <li>Contact support for help or issues.</li>
                </ul>
            </div>
        </section>

        <!-- About Section -->
        <section class="about-section">
            <h2>About Dispatch</h2>
            <p>Dispatch System is a modern delivery logistics platform tailored for dealers and bulk distributors. We streamline your dispatch needs with tracking, delivery assignment, and seamless order processing.</p>
            <div class="info-grid">
                <div class="info-block">
                    <h3>ğŸ“Œ Services We Offer</h3>
                    <ul>
                        <li>Delivery tracking</li>
                        <li>Order dispatch</li>
                        <li>Multi-region staff delivery system</li>
                        <li>Product analytics</li>
                    </ul>
                </div>
                <div class="info-block">
                    <h3>ğŸŒ Regions Covered</h3>
                    <p>We currently operate across Tamil Nadu with dedicated delivery zones:</p>
                    <ul>
                        <li>North TN</li>
                        <li>South TN</li>
                        <li>East TN</li>
                        <li>West TN</li>
                    </ul>
                </div>
                <div class="info-block">
                    <h3>â­ Why Choose Us?</h3>
                    <p>âœ” Faster deliveries<br>
                    âœ” tracking<br>
                    âœ” Dealer-focused system<br>
                    âœ” Predictive analytics for seasonal demand</p>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="org-footer">
        <h2>Dispatch System</h2>
        <p>Making logistics smoother, faster, and smarter â€” one delivery at a time.</p>
    </footer>

    <script>
    window.USER_ID = "{{ user.customer_id }}";
    document.addEventListener('DOMContentLoaded', function() {
        // Refresh Button Logic
        document.getElementById('refreshBtn').addEventListener('click', function() {
            window.location.reload();
        });
        // Profile dropdown toggle
        const profileBtn = document.getElementById('profileBtn');
        const dropdown = document.getElementById('dropdownContent');
        profileBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            dropdown.classList.toggle('show');
        });
        document.body.addEventListener('click', function() {
            dropdown.classList.remove('show');
        });

        // Theme toggle
        document.getElementById('themeToggle').addEventListener('click', function(e) {
            e.preventDefault();
            document.body.classList.toggle('dark-theme');
        });

        // Main dashboard logic
        const viewBtn = document.getElementById('viewOrdersBtn');
        const ordersSection = document.getElementById('ordersSection');
        const ordersList = document.getElementById('ordersList');
        const closeBtn = document.getElementById('closeOrdersBtn');
        const paymentModal = document.getElementById('paymentModal');
        const paymentOrderId = document.getElementById('paymentOrderId');
        const paymentAmount = document.getElementById('paymentAmount');
        const manualPaymentBtn = document.getElementById('manualPaymentBtn');
        const upiPaymentBtn = document.getElementById('upiPaymentBtn');
        const upiDetails = document.getElementById('upiDetails');
        const upiProofForm = document.getElementById('upiProofForm');
        const transactionIdInput = document.getElementById('transactionIdInput');
        const paymentProofInput = document.getElementById('paymentProofInput');

        function fetchOrders() {
            ordersList.textContent = 'Loading...';
            fetch(`/api/customer_orders/${window.USER_ID}`)
                .then(r => r.json())
                .then(orders => {
                    if (!orders.length) { 
                        ordersList.textContent = 'No orders found.'; 
                        return; 
                    }
                    ordersList.innerHTML = orders.map(o => {
                        const isPaid = o.payment_status && o.payment_status.toLowerCase() === 'paid';
                        return `
                        <div class="order-card" data-order-id="${o.id}">
                            <div><strong>Order Code:</strong> ${o.order_code}</div>
                            <div><strong>Status:</strong> ${o.status}</div>
                            <div><strong>Date:</strong> ${o.order_date}</div>
                            <div><strong>Warehouse:</strong> ${o.warehouse_name}</div>
                            <div><strong>Total:</strong> â‚¹${o.total_amount}</div>
                            <div><strong>Distance:</strong> ${o.distance_km} km</div>
                            <div><strong>Transport Cost:</strong> â‚¹${o.transport_cost}</div>
                            <div><strong>Estimated Time:</strong> ${o.transport_time_hours} hours</div>
                            <div><strong>Payment Status:</strong> ${o.payment_status || 'Pending'}</div>
                            <div><strong>Payment Mode:</strong> ${o.payment_mode || 'Not selected'}</div>
                            <div><strong>Items:</strong>
                                <ul style="margin:0;">
                                    ${o.items.map(i => `<li>${i.name} Ã— ${i.quantity}</li>`).join('')}
                                </ul>
                            </div>
                            <button class="track-delivery-btn" data-order-id="${o.id}" style="margin-top:10px;">Track Delivery</button>
                            ${isPaid ? 
                                '<p style="color:green;margin-top:10px;">Payment Completed</p>' : 
                                `<button class="pay-now-btn" data-order-id="${o.id}" data-amount="${o.total_amount}" style="background:#0077cc;color:white;padding:10px 20px;border:none;border-radius:5px;margin-top:10px;">Pay Now</button>`
                            }
                        </div>
                    `;
                    }).join('');
                })
                .catch(()=>{ ordersList.textContent = 'Failed to load orders.'; });
        }

        viewBtn.addEventListener('click', function() {
            ordersSection.style.display = 'block';
            document.getElementById('profileQuickView').style.display = 'none';
            document.getElementById('helpSection').style.display = 'none';
            fetchOrders();
        });

        closeBtn.addEventListener('click', function() {
            ordersSection.style.display = 'none';
        });

        ordersList.addEventListener('click', function(e) {
            if (e.target.classList.contains('track-delivery-btn')) {
                const orderId = e.target.getAttribute('data-order-id');
                fetch(`/api/order_status/${orderId}`)
                    .then(res => res.json())
                    .then(data => {
                        if (!data.success) { 
                            alert('Tracking info not available.'); 
                            return; 
                        }
                        renderTrackingSteps(data.status, data.dates || {});
                        document.getElementById('trackDeliveryModal').style.display = 'flex';
                    })
                    .catch(() => {
                        alert('Error fetching tracking information');
                    });
            }

            if (e.target.classList.contains('pay-now-btn')) {
                const orderId = e.target.getAttribute('data-order-id');
                const amount = e.target.getAttribute('data-amount');
                paymentOrderId.textContent = orderId;
                paymentAmount.textContent = amount;
                paymentModal.style.display = 'flex';
                manualPaymentBtn.setAttribute('data-order-id', orderId);
                upiPaymentBtn.setAttribute('data-order-id', orderId);
                upiDetails.style.display = 'none';
                upiProofForm.reset();
            }
        });

        manualPaymentBtn.addEventListener('click', async function() {
            const orderId = this.getAttribute('data-order-id');
            const formData = new FormData();
            formData.append('order_id', orderId);
            formData.append('payment_mode', 'manual');
            try {
                const res = await fetch('/api/update_payment_mode', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                if (data.success) {
                    alert('Manual payment selected. Please pay on delivery.');
                    paymentModal.style.display = 'none';
                    fetchOrders();
                } else {
                    alert('Failed to update payment mode: ' + (data.error || 'Unknown error'));
                }
            } catch (err) {
                alert('Error updating payment mode.');
            }
        });

        upiPaymentBtn.addEventListener('click', function() {
            upiDetails.style.display = 'block';
        });

        upiProofForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const orderId = upiPaymentBtn.getAttribute('data-order-id');
            const transactionId = transactionIdInput.value.trim();
            const file = paymentProofInput.files[0];
            if (!transactionId || !file) {
                alert('Please enter transaction ID and upload payment proof.');
                return;
            }
            const formData = new FormData();
            formData.append('order_id', orderId);
            formData.append('transaction_id', transactionId);
            formData.append('payment_proof', file);
            try {
                const res = await fetch('/api/submit_upi_payment', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                if (data.success) {
                    alert('UPI payment submitted for verification.');
                    paymentModal.style.display = 'none';
                    fetchOrders();
                } else {
                    alert('Failed to submit payment: ' + (data.error || 'Unknown error'));
                }
            } catch (err) {
                alert('Error submitting payment.');
            }
        });

        // Quick Profile Logic
        document.getElementById('quickProfileBtn').addEventListener('click', function() {
            document.getElementById('profileQuickView').style.display = 'block';
            document.getElementById('ordersSection').style.display = 'none';
            document.getElementById('helpSection').style.display = 'none';
            fetch(`/customer/profile/${window.USER_ID}`)
                .then(r => r.text())
                .then(html => {
                    document.getElementById('profileQuickContent').innerHTML = html;
                });
        });
        document.getElementById('closeProfileQuick').addEventListener('click', function() {
            document.getElementById('profileQuickView').style.display = 'none';
        });

        // Help Section Logic
        document.getElementById('helpBtn').addEventListener('click', function() {
            document.getElementById('helpSection').style.display = 'block';
            document.getElementById('ordersSection').style.display = 'none';
            document.getElementById('profileQuickView').style.display = 'none';
        });
        document.getElementById('closeHelp').addEventListener('click', function() {
            document.getElementById('helpSection').style.display = 'none';
        });
    });
    // End of script
    </script>
    <script src="{{ url_for('static', filename='js/customer.js') }}"></script>
</body>
</html>