<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Staff Dashboard | Dispatch</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/staff.css') }}">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="brand">🚚 <span>Dispatch System</span></div>
        <div class="profile-dropdown">
            <button id="profileBtn">{{ staff_name }} 👤</button>
            <div id="dropdownContent" class="dropdown-content">
                <a href="/staff/profile/{{user.staff_id}}">👤 View Profile</a>
                <a href="#" id="themeToggle">🌓 Toggle Theme</a>
                <a href="/logout">🚪 Logout</a>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero">
        <div class="hero-text">
            <h1>Welcome to Dispatch System</h1>
            <p>Empowering logistics with delivery routing and status tracking.</p>
            <ul>
                <li>🚚 Assign and manage regional delivery tasks efficiently</li>
                <li>📦 Track orders with instant status updates</li>
                <li>📈 Improve dispatch flow using control</li>
            </ul>
        </div>
        <div class="hero-visual">
        </div>
    </section>

    <!-- Dashboard Section -->
    <main class="dashboard">
        <header class="dashboard-header">
            <h2>Hello, <span class="staff-highlight">{{ staff_name }}</span> 👋</h2>
            <p style="color:#888;margin-top:4px;">Your personalized logistics dashboard</p>
        </header>
        <div class="cards">
            <button id="viewAssignedOrdersBtn" class="card small-card">📋 Assigned Orders</button>
            <button id="quickProfileBtn" class="card small-card">👤 Quick Profile</button>
            <button id="refreshBtn" class="card small-card">🔄 Refresh</button>
            <button id="helpBtn" class="card small-card">❓ Help</button>
        </div>

        <section id="assignedOrdersSection" class="assigned-orders-section" style="display:none;">
            <div class="section-header">
                <h2>🧾 Assigned Orders</h2>
                <button id="backToDashboardBtn" class="back-btn">Back</button>
            </div>
            <div id="assignedOrdersList" class="assigned-orders-list">Loading...</div>
        </section>

        <section id="profileQuickView" class="assigned-orders-section" style="display:none;">
            <div class="section-header">
                <h2>👤 Profile Quick View</h2>
                <button id="closeProfileQuick" class="back-btn">Close</button>
            </div>
            <div id="profileQuickContent" style="padding:1.2em;"></div>
        </section>

        <section id="helpSection" class="assigned-orders-section" style="display:none;">
            <div class="section-header">
                <h2>❓ Help & Tips</h2>
                <button id="closeHelp" class="back-btn">Close</button>
            </div>
            <div style="padding:1.2em;">
                <ul style="font-size:1.08em;color:#1976d2;">
                    <li>Click <b>Assigned Orders</b> to view and update your deliveries.</li>
                    <li>Use <b>Quick Profile</b> for a summary of your info.</li>
                    <li>Toggle between light/dark mode for comfort.</li>
                    <li>Contact admin for support or issues.</li>
                </ul>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="org-footer">
        <h2>Dispatch System</h2>
        <p>Making logistics smoother, faster, and smarter — one delivery at a time.</p>
    </footer>

    <script src="{{ url_for('static', filename='js/staff.js') }}"></script>
    <script>
    window.STAFF_ID = "{{ user.staff_id }}";
    document.addEventListener('DOMContentLoaded', function() {
        // Profile dropdown toggle
        const profileBtn = document.getElementById('profileBtn');
        const dropdown = document.getElementById('dropdownContent');
        profileBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            dropdown.classList.toggle('show');
        });
        document.body.addEventListener('click', function() {
            dropdown.classList.remove('show');
        });

        // Theme toggle
        document.getElementById('themeToggle').addEventListener('click', function(e) {
            e.preventDefault();
            document.body.classList.toggle('dark-theme');
        });

        // Assigned Orders Logic
        const viewBtn = document.getElementById('viewAssignedOrdersBtn');
        const ordersSection = document.getElementById('assignedOrdersSection');
        const ordersList = document.getElementById('assignedOrdersList');
        const backBtn = document.getElementById('backToDashboardBtn');

        function fetchOrders() {
            ordersList.textContent = 'Loading...';
            fetch(`/api/staff_orders/${window.STAFF_ID}`)
                .then(r => r.json())
                .then(orders => {
                    if (!orders.length) { ordersList.textContent = 'No assigned orders.'; return; }
                    ordersList.innerHTML = orders.map(o => `
                        <div class="order-card" data-order-id="${o.id}">
                            <div class="order-main">
                                <div>
                                    <span class="order-label">Order Code:</span> <span>${o.order_code}</span>
                                </div>
                                <div>
                                    <span class="order-label">Status:</span> <span id="status-${o.id}" class="order-status">${o.status}</span>
                                </div>
                                <div>
                                    <span class="order-label">Date:</span> <span>${o.order_date}</span>
                                </div>
                            </div>
                            <button class="update-status-btn" data-order-id="${o.id}">Update Delivery Status</button>
                            <div id="updateStatusDiv-${o.id}" class="update-status-div" style="display:none;">
                                <label for="newStatus-${o.id}">Set Status:</label>
                                <select id="newStatus-${o.id}">
                                    <option value="Order Confirmed">Order Confirmed</option>
                                    <option value="Shipped">Shipped</option>
                                    <option value="Out For Delivery">Out For Delivery</option>
                                    <option value="Delivered">Delivered</option>
                                </select>
                                <button onclick="updateOrderStatus(${o.id})" class="save-btn">Save</button>
                                <button onclick="document.getElementById('updateStatusDiv-${o.id}').style.display='none'" class="cancel-btn">Cancel</button>
                            </div>
                            <div class="order-extra">
                                <div>
                                    <span class="order-label">Warehouse:</span> <span>${o.warehouse_name}</span>
                                </div>
                                <div>
                                    <span class="order-label">Customer:</span> <span>${o.customer_name} (${o.email})</span>
                                </div>
                                <div>
                                    <span class="order-label">Total:</span> <span>₹${o.total_amount}</span>
                                </div>
                                <div>
                                    <span class="order-label">Items:</span>
                                    <ul>
                                        ${o.items.map(i => `<li>${i.name} × ${i.quantity}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    `).join('');
                })
                .catch(()=>{ ordersList.textContent = 'Failed to load orders.'; });
        }

        viewBtn.addEventListener('click', function(e) {
            e.preventDefault();
            ordersSection.style.display = 'block';
            document.getElementById('profileQuickView').style.display = 'none';
            document.getElementById('helpSection').style.display = 'none';
            fetchOrders();
        });

        backBtn.addEventListener('click', function() {
            ordersSection.style.display = 'none';
        });

        ordersList.addEventListener('click', function(e) {
            if (e.target.classList.contains('update-status-btn')) {
                const orderId = e.target.getAttribute('data-order-id');
                document.getElementById(`updateStatusDiv-${orderId}`).style.display = 'block';
            }
        });

        // Quick Profile Logic
        document.getElementById('quickProfileBtn').addEventListener('click', function() {
            document.getElementById('profileQuickView').style.display = 'block';
            document.getElementById('assignedOrdersSection').style.display = 'none';
            document.getElementById('helpSection').style.display = 'none';
            fetch(`/staff/profile/${window.STAFF_ID}`)
                .then(r => r.text())
                .then(html => {
                    document.getElementById('profileQuickContent').innerHTML = html;
                });
        });
        document.getElementById('closeProfileQuick').addEventListener('click', function() {
            document.getElementById('profileQuickView').style.display = 'none';
        });

        // Help Section Logic
        document.getElementById('helpBtn').addEventListener('click', function() {
            document.getElementById('helpSection').style.display = 'block';
            document.getElementById('assignedOrdersSection').style.display = 'none';
            document.getElementById('profileQuickView').style.display = 'none';
        });
        document.getElementById('closeHelp').addEventListener('click', function() {
            document.getElementById('helpSection').style.display = 'none';
        });

        // Refresh Button
        document.getElementById('refreshBtn').addEventListener('click', function() {
            window.location.reload();
        });
    });

    function updateOrderStatus(orderId) {
        const newStatus = document.getElementById(`newStatus-${orderId}`).value;
        fetch(`/api/update_order_status/${orderId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: newStatus })
        })
        .then(r => r.json())
        .then(res => {
            if (res.success) {
                document.getElementById(`status-${orderId}`).textContent = newStatus;
                document.getElementById(`updateStatusDiv-${orderId}`).style.display = 'none';
                alert('Status updated!');
            } else {
                alert('Failed to update status: ' + (res.error || 'Unknown error'));
            }
        })
        .catch(()=>alert('Failed to update status.'));
    }
    </script>
</body>
</html>