<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard - Smart Dispatch System</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
    <script src="{{ url_for('static', filename='js/admin.js') }}" defer></script>
    <style>
        .section { margin-bottom: 40px; padding: 20px; border-radius: 10px; background: #fff7f0; box-shadow: 0 2px 6px #eee;}
        table { width: 100%; border-collapse: collapse; margin-top:10px;}
        th, td { padding: 8px 12px; border: 1px solid #e0e0e0; }
        th { background: #ffeee3;}
        .img-thumb { width: 60px; }
        ul { margin: 0; padding-left: 18px; }
        .add-form input, .add-form select, .add-form textarea { margin-bottom: 6px; width: 95%; }
        .add-form { background: #f0f7ff; padding: 10px; border-radius: 8px; margin-bottom: 15px;}
        .success { color: green; font-weight: bold;}
        .error { color: red; font-weight: bold;}
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5);}
        .modal-content { background:#fff; padding:20px; margin:50px auto; width:400px; border-radius:8px;}
        .close { float:right; cursor:pointer; }
    </style>
</head>
<body style="background:#f6f6fa;">
    <div class="navbar">
        <div class="brand">üöö Smart Dispatch System</div>
        <div class="profile-dropdown">
            <button id="profileBtn">üõ°Ô∏è {{ user.name }}</button>
            <div id="dropdownContent" class="dropdown-content">
                <a href="/admin/profile/{{ user.admin_id }}">üëÅÔ∏è View Profile</a>
                <a href="/logout">üîí Logout</a>
            </div>
        </div>
    </div>

    <div class="dashboard">
        <h2>Welcome, <span style="color:#ff5722;">{{ user.name }}</span> üõ°Ô∏è</h2>
        <div class="section" id="emergency">
    <h2>üö® Emergency Stock Alerts</h2>
    <table>
        <thead>
            <tr>
                <th>Product</th>
                <th>Warehouse</th>
                <th>Message</th>
                <th>Time</th>
            </tr>
        </thead>
        <tbody id="emergencyTable">
            <tr><td colspan="4">Loading alerts...</td></tr>
        </tbody>
    </table>
</div>

<script>
async function loadEmergencyMessages() {
    const res = await fetch('/admin/emergency_messages');
    const data = await res.json();
    const tbody = document.getElementById('emergencyTable');
    tbody.innerHTML = data.length ? data.map(e => `
        <tr>
            <td>${e.product_name}</td>
            <td>${e.warehouse_name}</td>
            <td>${e.message}</td>
            <td>${new Date(e.created_at).toLocaleString()}</td>
        </tr>`).join('') : '<tr><td colspan="4">‚úÖ No emergency alerts!</td></tr>';
}
loadEmergencyMessages();
setInterval(loadEmergencyMessages, 15000); // auto-refresh every 15 sec
</script>

        <p>Manage and oversee your dispatch operations efficiently:</p>
        <div class="cards">
            <a href="#products" class="card">üõí Products</a>
            <a href="#inventory" class="card">üè¨ Inventory</a>
                <a href="#orders" class="card">üì¶ Orders</a>
                <a href="#customers" class="card">üë• Customers</a>
                <a href="#staff" class="card">üë®‚Äçüíº Staff</a>
        </div>
    <!-- Support Messages Modal -->
        <!-- Support Messages Modal removed -->
<!-- Support Messages JavaScript removed -->
    </div>

    <!-- Product Management -->
    <div class="section" id="products">
        <h2>üõí Product Management</h2>
        {% if prod_msg %}<p class="{{ 'success' if prod_success else 'error' }}">{{ prod_msg }}</p>{% endif %}
        <form class="add-form" method="POST" enctype="multipart/form-data" action="{{ url_for('admin_products', user_id=user.admin_id) }}">
            <input name="name" placeholder="Product Name" required style="width:140px;display:inline-block;">
            <input name="category" placeholder="Category" required style="width:120px;display:inline-block;">
            <input name="price" type="number" step="0.01" placeholder="Price" required style="width:90px;display:inline-block;">
            <input name="unit" placeholder="Unit (e.g. 300ml)" required style="width:90px;display:inline-block;">
            <input name="expiry_date" type="text" placeholder="Expiry Date (auto-calculated)" readonly style="width:140px;display:inline-block;">
            <select name="status" style="width:80px;display:inline-block;">
                <option value="available">Available</option>
                <option value="unavailable">Unavailable</option>
            </select>
            <br>
            <input name="manufacturing_date" type="date" placeholder="Manufacturing Date" required style="width:100px;display:inline-block; margin-top:4px;">
            <input name="image" type="file" accept="image/*" style="margin-top:4px;">
            <button type="submit" style="margin-top:4px;">Add Product</button>
        </form>
        <table>
            <tr>
                <th>Image</th><th>Name</th><th>Category</th><th>Unit</th><th>Price</th><th style="width:90px;">Manufacturing Date</th><th>Expiry Date</th><th style="width:70px;">Status</th>
            </tr>
            {% for p in products %}
            <tr>
                <td>{% if p.image %}<img src="{{ url_for('static', filename='uploads/' + p.image) }}" class="img-thumb">{% endif %}</td>
                <td>{{ p.name }}</td>
                <td>{{ p.category }}</td>
                <td>{{ p.unit }}</td>
                <td>{{ p.price }}</td>
                <td style="width:90px;">{{ p.manufacturing_date }}</td>
                <td>{{ p.expiry_date }}</td>
                <td style="width:70px;">{{ p.status }}</td>
            </tr>
            {% endfor %}
        </table>
    </div>

<div class="section">
    <h2>Manage Warehouses</h2>
    {% if wh_msg %}
    {% endif %}
    <form action="{{ url_for('admin_warehouses', user_id=user.admin_id) }}" method="POST" class="form-inline">
        <input type="text" name="name" placeholder="Warehouse Name" required>
        <input type="text" name="address" placeholder="Address" required>
        <input type="text" name="city" placeholder="City">
        <input type="text" name="state" placeholder="State">
        <input type="text" name="zip_code" placeholder="Zip Code">
        <button type="submit" class="btn btn-primary">Add Warehouse</button>
    </form>

    <table class="table">
        <thead>
            <tr>
                <th>ID</th><th>Name</th><th>Address</th><th>City</th><th>State</th><th>Zip</th>
            </tr>
        </thead>
        <tbody>
            {% for wh in warehouses %}
            <tr>
                <td>{{ wh.id }}</td>
                <td>{{ wh.name }}</td>
                <td>{{ wh.address }}</td>
                <td>{{ wh.city }}</td>
                <td>{{ wh.state }}</td>
                <td>{{ wh.zip_code }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="section">
    <h2>Manage Warehouse Stock</h2>
    {% if stock_msg %}
    {% endif %}

    <!-- Add / Update Stock Form -->
    <form action="{{ url_for('admin_warehouse_stock', user_id=user.admin_id) }}" method="POST" class="form-inline">
        <select name="warehouse_id" required>
            <option value="">Select Warehouse</option>
            {% for wh in warehouses %}
                <option value="{{ wh.id }}">{{ wh.name }}</option>
            {% endfor %}
        </select>

        <select name="product_id" required>
            <option value="">Select Product</option>
            {% for p in products %}
                <option value="{{ p.id }}">{{ p.name }}</option>
            {% endfor %}
        </select>

        <input type="number" name="quantity" placeholder="Quantity" min="1" required>
        <button type="submit" class="btn btn-primary">Add / Update Stock</button>
    </form>

    <!-- Stock Table -->
    <table class="table">
        <thead>
            <tr>
                <th>Warehouse</th>
                <th>Product</th>
                <th>Quantity</th>
            </tr>
        </thead>
        <tbody>
            {% for s in stock %}
            <tr{% if s.quantity < 100 %} class="low-stock-row"{% endif %}>
                <td>{{ s.warehouse_name }}</td>
                <td>{{ s.product_name }}</td>
                <td>{{ s.quantity }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>


    <!-- Orders -->
    <div class="section" id="orders">
        <h2>üì¶ Orders</h2>
        <table>
            <tr>
                <th>Order ID</th>
                <th>Customer</th>
                <th>City</th>
                <th>Status</th>
                <th>Date</th>
                    <th>Payment Status</th>
                <th>Total</th>
                <th>Actions</th>
            </tr>
            {% for o in orders %}
            <tr>
                <td>{{ o.id }}</td>
                <td>{{ o.customer_name }}<br>{{ o.email }}</td>
                <td>{{ o.city }}</td>
                <td>{{ o.status }}</td>
                <td>{{ o.order_date }}</td>
                    <td>{{ o.payment_status or '-' }}</td>
                <td>{{ o.total_amount }}</td>
                <td>
                    <button class="assign-staff-btn" data-id="{{ o.id }}" data-city="{{ o.city }}">Assign Staff</button>
                </td>
            </tr>
            {% endfor %}
        </table>
    </div>

    <!-- Customers -->
    <div class="section" id="customers">
        <h2>üë• Customers</h2>
        <table>
            <tr>
                <th>ID</th><th>Name</th><th>Email</th><th>Phone</th><th>Address</th><th>Actions</th>
            </tr>
            {% for c in customers %}
            <tr>
                <td>{{ c.customer_id }}</td>
                <td>{{ c.name }}</td>
                <td>{{ c.email }}</td>
                <td>{{ c.phone }}</td>
                <td>{{ c.address }}, {{ c.city }}, {{ c.state }}, {{ c.zip_code }}, {{ c.country }}</td>
                <td>
                    <button class="edit-btn" data-type="customer" data-id="{{ c.customer_id }}" data-data='{{ c|tojson }}'>Edit</button>
                    <button class="delete-btn" data-type="customer" data-id="{{ c.customer_id }}">Delete</button>
                </td>
            </tr>
            {% endfor %}
        </table>
    </div>

    <!-- Staff -->
    <div class="section" id="staff">
        <h2>üë®‚Äçüíº Staff</h2>
        <table>
            <tr>
                <th>ID</th><th>Name</th><th>Email</th><th>Phone</th><th>City</th><th>Actions</th>
            </tr>
            {% for s in staff %}
            <tr>
                <td>{{ s.staff_id }}</td>
                <td>{{ s.name }}</td>
                <td>{{ s.email }}</td>
                <td>{{ s.phone }}</td>
                <td>{{ s.city }}</td>
                <td>
                    <button class="edit-btn" data-type="staff" data-id="{{ s.staff_id }}" data-data='{{ s|tojson }}'>Edit</button>
                    <button class="delete-btn" data-type="staff" data-id="{{ s.staff_id }}">Delete</button>
                </td>
            </tr>
            {% endfor %}
        </table>
    </div>

    <!-- Modals -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>Edit</h3>
            <form id="editForm">
                <input type="hidden" id="editType" name="type">
                <input type="hidden" id="editId" name="id">
                <div id="editFields"></div>
                <button type="submit">Save</button>
            </form>
        </div>
    </div>

    <div id="orderModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>Order Details</h3>
            <div id="orderDetails"></div>
            <button id="assignStaffBtn">Assign Staff</button>
        </div>
    </div>

    <div id="staffAssignModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>Assign Staff</h3>
            <select id="staffSelect"></select>
            <button id="confirmAssignBtn">Assign</button>
        </div>
    </div>
</body>
    <div class="section" id="product-demand-visualization" style="background:linear-gradient(90deg,#e3ffe3 0%,#fff7f0 100%);box-shadow:0 2px 8px #d0f0d0;margin-top:40px;">
        <h2 style="color:#2196f3;">Product Demand Visualization</h2>
        <p style="margin-bottom:10px;color:#555;">current demand products</p>
        <canvas id="demandChart" style="max-width:700px;height:320px;margin:auto;display:block;background:#fff;border-radius:12px;"></canvas>
        <div id="topProduct" style="margin-top:10px;font-weight:bold;color:#388e3c;"></div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        var productDemand = {{ product_demand|tojson|safe }};
        const labels = productDemand.map(d => d.name);
        const values = productDemand.map(d => d.total_ordered);
        const topIdx = values.length ? values.indexOf(Math.max(...values)) : -1;
        const topProduct = topIdx >= 0 ? labels[topIdx] : 'None';
        document.getElementById('topProduct').innerHTML = topProduct !== 'None' ? `Currently in demand: <span style='color:#1976d2;'>${topProduct}</span>` : 'No orders yet.';
        const ctx = document.getElementById('demandChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Order Quantity',
                    data: values,
                    backgroundColor: labels.map((l,i) => i === topIdx ? 'rgba(255,99,132,0.7)' : 'rgba(54,162,235,0.5)'),
                    borderColor: labels.map((l,i) => i === topIdx ? '#d32f2f' : '#1976d2'),
                    borderWidth: 2,
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false },
                    title: { display: true, text: 'Live Product Demand', color:'#1976d2', font:{size:18} },
                    tooltip: { enabled: true }
                },
                scales: {
                    x: { title: { display: true, text: 'Product', color:'#1976d2' }, ticks:{color:'#1976d2'} },
                    y: { title: { display: true, text: 'Total Ordered', color:'#1976d2' }, beginAtZero: true, ticks:{color:'#1976d2'} }
                }
            }
        });
    </script>
</body>
</html>