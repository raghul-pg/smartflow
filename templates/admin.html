<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard - Smart Dispatch System</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
    <script src="{{ url_for('static', filename='js/admin.js') }}" defer></script>
    <style>
        .section { margin-bottom: 40px; padding: 20px; border-radius: 10px; background: #fff7f0; box-shadow: 0 2px 6px #eee;}
        table { width: 100%; border-collapse: collapse; margin-top:10px;}
        th, td { padding: 8px 12px; border: 1px solid #e0e0e0; }
        th { background: #ffeee3;}
        .img-thumb { width: 60px; }
        ul { margin: 0; padding-left: 18px; }
        .add-form input, .add-form select, .add-form textarea { margin-bottom: 6px; width: 95%; }
        .add-form { background: #f0f7ff; padding: 10px; border-radius: 8px; margin-bottom: 15px;}
        .success { color: green; font-weight: bold;}
        .error { color: red; font-weight: bold;}
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5);}
        .modal-content { background:#fff; padding:20px; margin:50px auto; width:400px; border-radius:8px;}
        .close { float:right; cursor:pointer; }
    </style>
</head>
<body style="background:#f6f6fa;">
    <div class="navbar">
        <div class="brand">üöö Smart Dispatch System</div>
        <div class="profile-dropdown">
            <button id="profileBtn">üõ°Ô∏è {{ user.name }}</button>
            <div id="dropdownContent" class="dropdown-content">
                <a href="/admin/profile/{{ user.admin_id }}">üëÅÔ∏è View Profile</a>
                <a href="/logout">üîí Logout</a>
            </div>
        </div>
    </div>

    <div class="dashboard">
        <h2>Welcome, <span style="color:#ff5722;">{{ user.name }}</span> üõ°Ô∏è</h2>
        <p>Manage and oversee your dispatch operations efficiently:</p>
        <div class="cards">
            <a href="#products" class="card">üõí Products</a>
            <a href="#inventory" class="card">üè¨ Inventory</a>
                <a href="#orders" class="card">üì¶ Orders</a>
                <a href="#customers" class="card">üë• Customers</a>
                <a href="#staff" class="card">üë®‚Äçüíº Staff</a>
        </div>
    <!-- Support Messages Modal -->
        <!-- Support Messages Modal removed -->
<!-- Support Messages JavaScript removed -->
    </div>

    <!-- Product Management -->
    <div class="section" id="products">
        <h2>üõí Product Management</h2>
        {% if prod_msg %}<p class="{{ 'success' if prod_success else 'error' }}">{{ prod_msg }}</p>{% endif %}
        <form class="add-form" method="POST" enctype="multipart/form-data" action="{{ url_for('admin_products', user_id=user.admin_id) }}">
            <div style="display: flex; gap: 10px; margin-bottom: 6px;">
                <input name="name" placeholder="Product Name" required style="width:140px;">
                <input name="category" placeholder="Category" required style="width:120px;">
                <input name="price" type="number" step="0.01" placeholder="Price" required style="width:90px;">
            </div>
            <div style="display: flex; gap: 10px; margin-bottom: 6px;">
                <input name="unit" placeholder="Unit (e.g. 300ml)" required style="width:90px;">
                <input name="expiry_date" type="text" placeholder="Expiry Date (auto-calculated)" readonly style="width:110px;">
                <select name="status" style="width:90px;">
                    <option value="available">Available</option>
                    <option value="unavailable">Unavailable</option>
                </select>
                <input name="manufacturing_date" type="date" placeholder="Manufacturing Date" required style="width:110px;">
            </div>
            <div style="display: flex; gap: 10px; margin-bottom: 6px; align-items: center;">
                <input name="image" type="file" accept="image/*" style="width:160px;">
                <button type="submit" style="width:120px;">Add Product</button>
            </div>
        </form>
        <table>
            <tr>
                <th>Image</th><th>Name</th><th>Category</th><th>Unit</th><th>Price</th><th>Manufacturing Date</th><th>Expiry Date</th><th>Status</th>
            </tr>
            {% for p in products %}
            <tr>
                <td>{% if p.image %}<img src="{{ url_for('static', filename='uploads/' + p.image) }}" class="img-thumb">{% endif %}</td>
                <td>{{ p.name }}</td>
                <td>{{ p.category }}</td>
                <td>{{ p.unit }}</td>
                <td>{{ p.price }}</td>
                <td>{{ p.manufacturing_date }}</td>
                <td>{{ p.expiry_date }}</td>
                <td>{{ p.status }}</td>
            </tr>
            {% endfor %}
        </table>
    <script>
    // Auto-update status to unavailable if expiry date is met in the table (client-side only)
    document.addEventListener('DOMContentLoaded', function() {
        const today = new Date().toISOString().split('T')[0];
        document.querySelectorAll('#products table tr').forEach(function(row, idx) {
            if(idx === 0) return; // skip header
            const expiryCell = row.cells[6];
            const statusCell = row.cells[7];
            if(expiryCell && statusCell) {
                const expiry = expiryCell.textContent.trim();
                if(expiry && expiry <= today) {
                    statusCell.textContent = 'Unavailable';
                }
            }
        });
    });
    </script>
    </div>

<div class="section">
    <h2>Manage Warehouses</h2>
    {% if wh_msg %}
    {% endif %}
    <form action="{{ url_for('admin_warehouses', user_id=user.admin_id) }}" method="POST" class="form-inline">
        <input type="text" name="name" placeholder="Warehouse Name" required>
        <input type="text" name="address" placeholder="Address" required>
        <input type="text" name="city" placeholder="City">
        <input type="text" name="state" placeholder="State">
        <input type="text" name="zip_code" placeholder="Zip Code">
        <button type="submit" class="btn btn-primary">Add Warehouse</button>
    </form>

    <table class="table">
        <thead>
            <tr>
                <th>ID</th><th>Name</th><th>Address</th><th>City</th><th>State</th><th>Zip</th>
            </tr>
        </thead>
        <tbody>
            {% for wh in warehouses %}
            <tr>
                <td>{{ wh.id }}</td>
                <td>{{ wh.name }}</td>
                <td>{{ wh.address }}</td>
                <td>{{ wh.city }}</td>
                <td>{{ wh.state }}</td>
                <td>{{ wh.zip_code }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="section">
    <h2>Manage Warehouse Stock</h2>
    {% if stock_msg %}
    {% endif %}

    <!-- Add / Update Stock Form -->
    <form action="{{ url_for('admin_warehouse_stock', user_id=user.admin_id) }}" method="POST" class="form-inline">
        <select name="warehouse_id" required>
            <option value="">Select Warehouse</option>
            {% for wh in warehouses %}
                <option value="{{ wh.id }}">{{ wh.name }}</option>
            {% endfor %}
        </select>

        <select name="product_id" required>
            <option value="">Select Product</option>
            {% for p in products %}
                <option value="{{ p.id }}">{{ p.name }}</option>
            {% endfor %}
        </select>

        <input type="number" name="quantity" placeholder="Quantity" min="1" required>
        <button type="submit" class="btn btn-primary">Add / Update Stock</button>
    </form>

    <!-- Stock Table -->
    <table class="table">
        <thead>
            <tr>
                <th>Warehouse</th>
                <th>Product</th>
                <th>Quantity</th>
            </tr>
        </thead>
        <tbody>
            {% for s in stock %}
            <tr{% if s.quantity < 100 %} class="low-stock-row"{% endif %}>
                <td>{{ s.warehouse_name }}</td>
                <td>{{ s.product_name }}</td>
                <td>{{ s.quantity }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>


    <!-- Orders -->
    <div class="section" id="orders">
        <h2>üì¶ Orders</h2>
        <table>
            <tr>
                <th>Order ID</th>
                <th>Customer</th>
                <th>City</th>
                <th>Status</th>
                <th>Date</th>
                <th>Delivery</th>
                <th>Total</th>
                <th>Actions</th>
            </tr>
            {% for o in orders %}
            <tr>
                <td>{{ o.id }}</td>
                <td>{{ o.customer_name }}<br>{{ o.email }}</td>
                <td>{{ o.city }}</td>
                <td>{{ o.status }}</td>
                <td>{{ o.order_date }}</td>
                <td>{{ o.delivery_date or '-' }}</td>
                <td>{{ o.total_amount }}</td>
                <td>
                    <button class="assign-staff-btn" data-id="{{ o.id }}" data-city="{{ o.city }}">Assign Staff</button>
                </td>
            </tr>
            {% endfor %}
        </table>
    </div>

    <!-- Customers -->
    <div class="section" id="customers">
        <h2>üë• Customers</h2>
        <table>
            <tr>
                <th>ID</th><th>Name</th><th>Email</th><th>Phone</th><th>Address</th><th>Actions</th>
            </tr>
            {% for c in customers %}
            <tr>
                <td>{{ c.customer_id }}</td>
                <td>{{ c.name }}</td>
                <td>{{ c.email }}</td>
                <td>{{ c.phone }}</td>
                <td>{{ c.address }}, {{ c.city }}, {{ c.state }}, {{ c.zip_code }}, {{ c.country }}</td>
                <td>
                    <button class="edit-btn" data-type="customer" data-id="{{ c.customer_id }}" data-data='{{ c|tojson }}'>Edit</button>
                    <button class="delete-btn" data-type="customer" data-id="{{ c.customer_id }}">Delete</button>
                </td>
            </tr>
            {% endfor %}
        </table>
    </div>

    <!-- Staff -->
    <div class="section" id="staff">
        <h2>üë®‚Äçüíº Staff</h2>
        <table>
            <tr>
                <th>ID</th><th>Name</th><th>Email</th><th>Phone</th><th>City</th><th>Actions</th>
            </tr>
            {% for s in staff %}
            <tr>
                <td>{{ s.staff_id }}</td>
                <td>{{ s.name }}</td>
                <td>{{ s.email }}</td>
                <td>{{ s.phone }}</td>
                <td>{{ s.city }}</td>
                <td>
                    <button class="edit-btn" data-type="staff" data-id="{{ s.staff_id }}" data-data='{{ s|tojson }}'>Edit</button>
                    <button class="delete-btn" data-type="staff" data-id="{{ s.staff_id }}">Delete</button>
                </td>
            </tr>
            {% endfor %}
        </table>
    </div>

    <!-- Product Demand Visualization -->
    <div class="section" id="product-demand-visualization">
        <h2>üìä Product Demand Visualization</h2>
        <canvas id="demandChart" width="600" height="300"></canvas>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        fetch('/api/product_demand')
            .then(res => res.json())
            .then(data => {
                const labels = data.map(d => d.name);
                const values = data.map(d => d.total_ordered);
                const ctx = document.getElementById('demandChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Product Demand',
                            data: values,
                            backgroundColor: 'rgba(54, 162, 235, 0.6)'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false },
                            title: { display: true, text: 'Product Demand (Order Quantity)' }
                        },
                        scales: {
                            x: { title: { display: true, text: 'Product' } },
                            y: { title: { display: true, text: 'Total Ordered' }, beginAtZero: true }
                        }
                    }
                });
            });
    });

        // Render the chart
        const demandChart = new Chart(
            document.getElementById('demandChart'),
            config
        );
    </script>

    <!-- Modals -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>Edit</h3>
            <form id="editForm">
                <input type="hidden" id="editType" name="type">
                <input type="hidden" id="editId" name="id">
                <div id="editFields"></div>
                <button type="submit">Save</button>
            </form>
        </div>
    </div>

    <div id="orderModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>Order Details</h3>
            <div id="orderDetails"></div>
            <button id="assignStaffBtn">Assign Staff</button>
        </div>
    </div>

    <div id="staffAssignModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>Assign Staff</h3>
            <select id="staffSelect"></select>
            <button id="confirmAssignBtn">Assign</button>
        </div>
    </div>
</body>
</html>